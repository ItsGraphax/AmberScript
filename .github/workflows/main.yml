name: Watch File Commits

on:
  push:
    paths:
      - 'amberscript.sb3'

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Send Discord Embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE=$(git log -1 --pretty=%s)
          DESCRIPTION=$(git log -1 --pretty=%b)
          DESCRIPTION=${DESCRIPTION:-"No description"}
          AUTHOR_EMAIL=$(git log -1 --pretty=%ae)
          AUTHOR_NAME=$(git log -1 --pretty=%an)

          GH_USERNAME=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/search/users?q=${AUTHOR_EMAIL}+in:email" | jq -r '.items[0].login // empty')

          # Fallback to git author name if GH username not found
          AUTHOR_DISPLAY_NAME=${GH_USERNAME:-$AUTHOR_NAME}

          curl -X POST "$DISCORD_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "$(jq -n \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --arg author "$AUTHOR_DISPLAY_NAME" \
            '{
              content: null,
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: 16730184,
                  author: {
                    name: $author
                  }
                }
              ],
              attachments: []
            }')"
